# 本地工作区 AI 接手上下文

> 更新时间：2026-02-12  
> 目的：让后续 AI 直接基于当前事实继续开发，避免重复决策和回退。

## 1. 当前能力边界（已落地）

- 工作区定位：仅管理“当前知识本（空间）内文档树”，不在侧栏提供空间管理能力。
- 侧栏结构：无“额头部”头区，直接展示目录树。
- 侧栏交互：支持拖拽调宽、支持隐藏/展开、宽度与折叠状态持久化。
- 目录树组件：已使用 `react-complex-tree` 实现树形结构展示与交互。
- 目录树可点击策略：不只叶子节点，所有文档节点都可点击打开（含可展开文档节点）。
- 节点选中态：当前激活文档节点会高亮灰色背景。
- 节点 hover 行为：节点区域为手型光标，右侧出现 `+` 操作入口。
- 节点菜单动作：新建子文档、新建同级文档、新建子目录、重命名、删除。
- 新建与重命名交互：使用树内原位输入框，不再使用 `prompt`。
- 输入框行为：`Enter` 提交、`Esc` 取消、失焦自动提交。
- 树节点样式基线：行高 `36px`，去边框风格，样式以 Tailwind 为主。

## 2. 刷新恢复与持久化（已生效）

- 刷新页面后会恢复上次激活空间与激活文档。
- 恢复后会自动加载该文档内容到编辑区，并保持树节点选中态。
- 本地持久化键（localStorage）：
- `workspace.activeSpaceId`
- `workspace.activeDocId`
- `workspace.sidebar.width`
- `workspace.sidebar.collapsed`
- 启动恢复回退规则：
- 若上次空间不存在，回退到可用首个空间。
- 若上次文档不存在或不再是文档节点，回退到空间首篇文档。
- 若空间内无文档，自动创建默认文档兜底。

## 3. 数据层与 ID 策略（已落地）

- 本地数据存储已从 `localStorage` 模式迁移为 IndexedDB（Dexie 抽象）。
- 业务 ID 策略：统一使用 `ulid`，输出为 26 位小写字符串。
- ULID 冲突策略：生成后做重复检测，冲突自动重试（默认最多 8 次）。
- 自增 ID 策略：本地表保留 `id` 自增技术主键，但业务逻辑不依赖。
- 当前 IndexedDB 核心表：
- `users`
- `meta`
- `spaces`
- `nodes`
- `documents`
- `revisions`
- 文档与节点关联约束：当前实现保持 `document.ulid === node.ulid`（兼容现有打开链路）。
- 删除策略：删除节点会递归删除子树；文档节点会联动清理 `documents/revisions`。

## 4. 已确认的产品约束（请继续遵守）

- 本期不做拖拽排序，但必须保留可扩展入口。
- 本期不做空间删除，但必须保留可扩展入口。
- 允许重命名为重复名称（目录/文档都允许重名）。
- 业务主键禁止使用自增 ID。
- 未来接数据库时可保留自增 `id`，但业务关联和外部引用使用 `ulid`。

## 5. 扩展点与接口约定（已预留）

- `workspace.moveNode`：拖拽排序扩展点已保留能力位（当前未实现）。
- `workspace.deleteSpace`：空间删除扩展点已保留能力位（当前未实现）。
- 树节点创建链路约定：`onCreateNode` 需要返回 `CreateNodeResult`，供 UI 进入原位编辑态。

## 6. 后续 AI 高优先级注意事项

- 不要把树节点创建/重命名改回 `prompt`，保持原位输入交互一致性。
- 不要移除“所有文档可点击”的行为开关（`canInvokePrimaryActionOnItemContainer`）。
- 不要打破“选中背景”互斥类逻辑，避免激活态被 `bg-transparent` 覆盖。
- 不要在 Dexie 事务内做事务外异步操作（尤其是 ID 生成），否则会触发：
- `Transaction committed too early`
- 保持 `WorkspaceTree`、`WorkspaceSidebar` 的 Tailwind 风格基线，不要回退到散落 CSS。
- 若改动启动流程，必须保证“刷新后恢复激活文档 + 自动加载内容”不回归。

## 7. 建议验证基线（每次继续开发后）

- 构建验证：`npm run web:build`
- 手工验证重点：
- 点击任意文档节点都能打开并高亮。
- 新建文档后出现树内输入框，输入后正确保存名称。
- 重命名走树内输入框（Enter/Esc/Blur 行为正确）。
- 刷新页面后仍定位到上次激活文档，编辑区内容同步恢复。
- 侧栏宽度与折叠状态刷新后保持。
